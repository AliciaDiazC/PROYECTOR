---
title: "Rmarkdown_Proyecto_final"
author: "Alicia Díaz Castillo"
date: "18/11/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r enc, echo=FALSE, message=FALSE, warning=FALSE}
options(Encoding="UTF-8")
```
Para una mayor personalización, considera los paquetes xtable, stargazer, pander, tables, y ascii.

## EXPRESIONES REGULARES

En esta sección seleccionaremos dos páginas web explicando expresiones regulares en R.
 
La primera es <http://rpubs.com/ydmarinb/429756>, esta me gusta mucho, me parece que viene muy bien explicado y estructurado. Al empezar da una breve explicación sobre que son las expresiones regulares. Además, está estructurado de una manera para que el lector lo comprenda al momento, y si quiere algo en especial, solo tiene que pinchar en el índice. En cada parte viene con un ejemplo para enseñar como se usaría cada expresión. Y además está creado con Rmarkdown.

La segunda es <http://www.diegocalvo.es/expresiones-regulares-en-r/>, comparado con la anterior me parece que la estructura no es tan buena. Desde mi punto de vista le falta una pequeña explicacción para los que no saben que son, y se centra menos en la explicación de cada función. 
 

## RMARKDOWN
.

En esta sección vamos a comparar dos páginas web en las que expliquen Rmardown.

Empezaremos con <https://bookdown.org/gboccardo/manual-ED-UCH/introduccion-al-uso-de-rmarkdown-para-la-compilacion-de-resultados-de-rstudio-en-diferentes-formatos.html#tabla-de-estadisticos-univariados>. Lo contenidos estan muy bien explicados, en profundidad. Y te explica como crear todo tipo de elementos como tablas o listas. La estructura de como viene organizado el contenido esta muy bien ya que explica del contenido más siemple al más complicado.

Por último, <https://rpubs.com/JohanMarin/Rmarkdown>. Desde mi punto de vista este es más visual que el anterior. En contenidos explican más o menos lo mismo, sin embargo, este explica como incluir imágenes, código in-line, strings externos. Aunque la estructura no es lo mejor, ya que explica como crear tablas o listas, antes de explicar lo más principal. Y un punto a su favor es que esta hecho en Rmarkdown.

## ESTUDIO DE LOS VOTOS DEL PAÍS VASCO EN EL 2016.

Los datos los he obtenido de la pagina web <http://opendata.esri.es/datasets/pais-vasco-elecciones-auton%C3%B3micas-2016/geoservice>, usando su API, con formato geojson. Primeramente lo transformamos a formato tabla, y la iremos mejorando estéticamente, renombrando las columnas, eliminando columnas que no daban información y transfromando el formato de la fecha en fecha.

```{r json, echo=FALSE, message=FALSE, warning=FALSE}
library(jsonlite)
votos_json <- readLines("https://opendata.arcgis.com/datasets/828179cabe6f479691b08560f41af197_0.geojson", encoding = "UTF-8")
Votos_list <- fromJSON(votos_json, flatten = TRUE)
```
```{r mej, echo=FALSE, message=FALSE, warning=FALSE}
Votos <- Votos_list$features
colnames(Votos) <-gsub("properties.", "", colnames(Votos))
Votos$type <- NULL
Votos$geometry.type <- NULL
Votos$geometry.coordinates <- NULL
```
```{r fecha, echo=FALSE, message=FALSE, warning=FALSE}
library(lubridate)
Votos$Fecha <- ymd_hms(Votos$Fecha, tz = "Europe/Madrid")
```
 (((Escribir la tabla en forma bonita)))
 
### Relación entre el censo y el número de votantes.
 
 En esta sección relacionaremos el número de población de cada distrito con el número de votantes. Como se puede observar en la siguiente tabla las ciudades más pobladas coinciden con las capitales de Álava, Guipúzcoa y Vizcaya.
 
```{r censo, echo=FALSE, message=FALSE, warning=FALSE}
head(Votos[order(-Votos$Censo),c("AMBITO","Censo")]) #hacerla mas bonita
```

Para poder realizar el estudio más facilmente creamos unas nuevas columnas que contienen el porcentaje de participación de cada distrito y el ranking del censo, en orden descendente, es decir el número uno será el más poblado. 

Representamos la relación entre porcentaje de población y el ranking del censo con la siguiente gráfica de puntos y una línea de regresión. Resultando una ligera relación indirecta, en los pueblos más pequeños aumenta el porcentaje de votaciones, mientras que en las grandes ciudades la media de votación es entorno a un 60%. También se observa que a medida que disminuye la población el porcentaje de población es más dispar, es decir, algunos pueblos llegan al 85% de participación en las elecciones, mientras que otros se quedan con un 53%.

```{r porc, echo=FALSE, message=FALSE, warning=FALSE}
library(dplyr)
Votos$Porcentaje_participacion <- Votos$Votantes*100/Votos$Censo
Votos$Rank_censo <- rank(-Votos$Censo)
Votos2 <- Votos %>%
  select(AMBITO, Rank_censo, Porcentaje_participacion) %>%
  filter(!is.na(Porcentaje_participacion)) %>%
  arrange(Porcentaje_participacion)
```
```{r provincia, echo=FALSE, message=FALSE, warning=FALSE}
Votos <- mutate(Votos,
             Provincia = codine) 
library(stringr)
Votos$Provincia <- str_replace(Votos$Provincia,"01[0-9][0-9][0-9]", "Álava")
Votos$Provincia <- str_replace(Votos$Provincia,"20[0-9][0-9][0-9]", "Guipúzcoa")
Votos$Provincia <- str_replace(Votos$Provincia,"48[0-9][0-9][0-9]", "Vizcaya")
```
```{r plot, echo=FALSE, message=FALSE, warning=FALSE}
library(ggplot2)
Votos <- Votos %>%
    filter(!is.na(Censo)) 
r <-  ggplot(Votos, aes(x = Rank_censo, y = Porcentaje_participacion, colour = Provincia)) +geom_point() + geom_smooth(alpha = 0.2) 
r
``` 

A continuación, estudiaremos el porcentaje de votación y el tipo de población de cada provincia, para ello identificamos cada provincia con el código postal de cada distrito creando una nueva columna llamada _Provincia_. 

En el siguiente diagrama de violin comparamos el porcentaje de población por provincias. Se puede apreciar que la media del porcentaje de votos es más alto en Vizcaya, además de estar más equilibrado. Guipúzcoa y Álava estan bastante igualadas. Sin embargo, en Álava es donde se registran los menores porcentajes y en Guipúzcoa los mayores. Además, Guipúzcoa destaca porque en la mayoría de distritos el porcentaje se encuentra alrededor de un 63%.

(2 gráficas al lado)

```{r violin, echo=FALSE, message=FALSE, warning=FALSE}
v  <-  ggplot(Votos, aes(x = Provincia, y = Porcentaje_participacion)) +geom_violin()
v
```

En el diagrama de violin del ranking del censo, hay una gran diferencia del tipo de población de Álava con los otros dos. En Álava lo que más hay son pueblos pequeños o medianos, entre el ranking 150 y 245, A partir de 150 va disminuyendo el número, y ciudades grandes, hay muy pocas. Entre Vizcaya y guipúzcoa no hay gran diferenciam lo único que en Vizcaya no se encuentran casi pueblos pequeños, y Guipúzcoa tiene mucha variendad entre tipo de población teniendo casi el mismo número de pueblos pequeños que ciudades grandes.


```{r censv, echo=FALSE, message=FALSE, warning=FALSE}
c<-  ggplot(Votos, aes(x = Provincia, y = Rank_censo)) +geom_violin()
c
```


Lo curioso es que el pueblo con menos habitantes del País Vasco pertenece a Guipúzcoa y es el que tiene mayor porcentaje de votos de todos los distritos.

No se encuentra ninguna relación entre el número de habitantes y de votos ya que en eñ  gráfico de puntos se observa que los pueblos pequeños tienen mayor porcentaje de voto y en las ciudades grandes menos. En Vizcaya, por lo general se vota más en todos los distritos, sean del tipo que sean.


Veamos quien gana, si pp, psoe o quien, suma.

nulos, abstenciones, blancos, provincias, facetas.

Relacion de nulos por provincias dependiendo del numero de votos

Hallar el maximo de cada distrito y luego hacer una mapa lealeft

### Partidos.

En esta sección estudiaremos los votos de los partidos, cuales son los más votados, y cuales los menos.

Dividido por provincias.

```{r provpart, echo=FALSE, message=FALSE, warning=FALSE}
library(reshape2)
library(plyr)
Votos4<- Votos %>%
  select(Provincia, Censo, c(11:26))
Votos5 <- ddply(Votos4, .(Provincia), 
             transform, total_hab = sum(Censo))
V6 <-  melt(Votos5, id.vars = c("Provincia", "Censo","total_hab"))
V7 <- ddply(V6, .(Provincia,total_hab, variable), summarize, total = sum(value))
V8 <- ddply(V7, .(Provincia), 
             transform, porc_part = total*100/total_hab)
bar <-  ggplot(V8, aes(x=variable,y = porc_part)) +geom_bar(stat = "identity") + facet_grid(Provincia ~.)
bar 
```



Veamos cual gana. 
```{r v_3_p, echo=FALSE, message=FALSE, warning=FALSE}
V9 <- ddply(V7, .(Provincia), 
             transform, rank_partidos = rank(-total, ties = "random"))
rank_part <- V9[V9$rank_partidos == 1 |V9$rank_partidos == 2|V9$rank_partidos == 3,c(1,3,5)]
rank_part
```

Los partidos más votados son EAJ_PNV y EH_BILDU.

Vamos a hallar el partido más votado en cada distrito.
```{r part, echo=FALSE, message=FALSE, warning=FALSE}
c4<- Votos %>%
  select(AMBITO, c(11:26))
c5 <- melt(c4, id.vars = c("AMBITO"))
c6 <- ddply(c5, .(AMBITO), 
            transform, voto_part = rank(-value, ties = "random"))
rank_voto <-c6[c6$voto_part == 1,c(1,2,3)]
head(rank_voto)
```
Solo me falta el mapa.